<Chart Config="_paxDemandConfig" @ref="_paxDemandChart" Height="500px" />

@code {
    private LineChartConfig _paxDemandConfig = new();
    private Chart? _paxDemandChart;

    private List<PaxDemandModel> PaxDemand { get; set; } = new();


    public void OnInit(List<HistoricoAssistencia> historico)
    {
        if (historico != null)
        {
            PaxDemand = FillData(historico);
            _paxDemandConfig = new LineChartConfig()
                {
                    Options = new Options()
                    {
                        Responsive = true,
                        MaintainAspectRatio = false,
                        Plugins = new Plugins()
                        {
                            Legend = new Legend()
                            {
                                Align = LegendAlign.Center,
                                Display = true,
                                Position = LegendPosition.Bottom
                            }
                        },
                    }
                };

            _paxDemandConfig.Data.Labels = PaxDemand.Select(d => d.Dias.ToString("d/MMM")).ToList();
            _paxDemandConfig.Data.Datasets.Add(new LineDataset()
                {
                    Label = "Real",
                    Data = PaxDemand.Select(d => d.Total).ToList(),
                    BackgroundColor = "rgba(220,20,60,0.2)",
                    BorderColor = "rgba(220,20,60,1)",
                    Fill = true
                });
            _paxDemandConfig.Data.Datasets.Add(new LineDataset()
                {
                    Label = "Dep.",
                    Data = PaxDemand.Select(d => d.Partidas).ToList(),
                    BackgroundColor = "rgba(34,139,34,0.2)",
                    BorderColor = "rgba(34,139,34,1)",
                    Fill = true
                });
            _paxDemandConfig.Data.Datasets.Add(new LineDataset()
                {
                    Label = "Arr.",
                    Data = PaxDemand.Select(d => d.Chegadas).ToList(),
                    BackgroundColor = "rgba(30,144,255,0.2)",
                    BorderColor = "rgba(30,144,255,1)",
                    Fill = true
                });
            StateHasChanged();
        }

    }

    public List<PaxDemandModel> FillData(List<HistoricoAssistencia> historico)
    {
        List<PaxDemandModel> result = historico.AsEnumerable()
            .GroupBy(d => new { Dia = d.Data.Date })
            .Select(x => new PaxDemandModel
                {
                    Dias = x.Key.Dia,
                    Total = x.Count(d => d.Data.Date.Equals(x.Key.Dia.Date)),
                    Partidas = x.Count(d => d.Data.Date.Equals(x.Key.Dia.Date) && d.Mov == "D"),
                    Chegadas = x.Count(d => d.Data.Date.Equals(x.Key.Dia.Date) && d.Mov == "A"),
                }).OrderBy(d => d.Dias).ToList();
        return result;
    }
}
