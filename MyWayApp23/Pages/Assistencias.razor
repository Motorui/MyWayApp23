@page "/assistencias"

@using MyWayApp23.Data
@inject IHistoricoDetalheService detalheService

@inject ISnackbar Snackbar

<PageTitle>Detalhes</PageTitle>

<AuthorizeView Context="AuthContext">
    <Authorized>
        @if (detalhes.Count() <= 1)
        {
            <MudOverlay Visible="isVisible" DarkBackground="true" ZIndex="9999">
                <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
            </MudOverlay>
        }
        else
        {
            <MudDatePicker Label="Mês" OpenTo="OpenTo.Month" Date="@_date"
                       DateChanged="OnDateChange" Required="true" DateFormat="MMM"
                       FixDay="1" />

            <MudTable Items="@detalhes" Dense="true" Hover="true" Bordered="true"
                  Striped="true" Loading="isVisible" RowsPerPage="31">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">@_date?.ToString("MMM")</MudText>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>Data</MudTh>
                    <MudTh>Dia</MudTh>
                    <MudTh>Total</MudTh>
                    <MudTh>DEP</MudTh>
                    <MudTh>% DEP</MudTh>
                    <MudTh>ARR</MudTh>
                    <MudTh>% ARR</MudTh>
                    <MudTh>JetBridge</MudTh>
                    <MudTh>% JetBridge</MudTh>
                    <MudTh>Remote</MudTh>
                    <MudTh>% Remote</MudTh>
                    <MudTh>>36H</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Data">@context.Data</MudTd>
                    <MudTd DataLabel="Dia">@context.DiaSemana</MudTd>
                    <MudTd DataLabel="Total">@context.TotalDia</MudTd>
                    <MudTd DataLabel="DEP">@context.Dep</MudTd>
                    <MudTd DataLabel="% DEP">@context.DepPercentage</MudTd>
                    <MudTd DataLabel="ARR">@context.Arr</MudTd>
                    <MudTd DataLabel="% ARR">@context.ArrPercentage</MudTd>
                    <MudTd DataLabel="JetBridge">@context.JetBridge</MudTd>
                    <MudTd DataLabel="% JetBridge">@context.JetBridgePercentage</MudTd>
                    <MudTd DataLabel="Remote">@context.Remote</MudTd>
                    <MudTd DataLabel="% Remote">@context.RemotePercentage</MudTd>
                     <MudTd DataLabel=">36h">@context.Mais36</MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager RowsPerPageString="Linhas por página"
                               InfoFormat="{first_item} a {last_item} de {all_items}" />
                </PagerContent>
            </MudTable>
        }

    </Authorized>
    <NotAuthorized>
        <_403 />
    </NotAuthorized>
</AuthorizeView>

@code {
    bool isVisible = true;
    DateTime? _date = DateTime.Today;
    //private IEnumerable<HistoricoAssistencia> historico = new List<HistoricoAssistencia>();
    private IEnumerable<HistoricoDetalhe> detalhes = new List<HistoricoDetalhe>();

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(500);
        //historico = historicoService.GetAll().OrderByDescending(d => d.Data);
        detalhes = detalheService.GetDetalhes(DateTime.UtcNow).OrderByDescending(d => d.Data);
        isVisible = false;
    }

    private void OnDateChange(DateTime? newDate)
    {
        _date = newDate;
        if (newDate != null)
            detalhes = detalheService.GetDetalhes((DateTime)newDate).OrderByDescending(d => d.Data);

        //StateHasChanged();
    }

}
