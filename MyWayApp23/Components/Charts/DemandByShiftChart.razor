<Chart Config="_demandsByShiftChartConfig" @ref="_demandsByShiftChart" Height="500px" />

@code {
    private LineChartConfig _demandsByShiftChartConfig = new();
    private Chart? _demandsByShiftChart;

    private List<DemandByShiftModel> demandsByShift { get; set; } = new();

    public void OnInit(List<HistoricoAssistencia> historico)
    {
        if (historico != null)
        {
            demandsByShift = FillData(historico);
            _demandsByShiftChartConfig = new LineChartConfig()
                {
                    Options = new Options()
                    {
                        Responsive = true,
                        MaintainAspectRatio = false,
                        Plugins = new Plugins()
                        {
                            Legend = new Legend()
                            {
                                Align = LegendAlign.Center,
                                Display = true,
                                Position = LegendPosition.Bottom
                            }
                        },
                    }
                };

            _demandsByShiftChartConfig.Data.Labels = demandsByShift.Select(d => d.Dias.ToString("d/MMM")).ToList();
            _demandsByShiftChartConfig.Data.Datasets.Add(new LineDataset()
                {
                    Label = "Manhã",
                    Data = demandsByShift.Select(d => d.Manha).ToList(),
                    BackgroundColor = "rgba(220,20,60,0.2)",
                    BorderColor = "rgba(220,20,60,1)",
                    Fill = true
                });
            _demandsByShiftChartConfig.Data.Datasets.Add(new LineDataset()
                {
                    Label = "Tarde",
                    Data = demandsByShift.Select(d => d.Tarde).ToList(),
                    BackgroundColor = "rgba(34,139,34,0.2)",
                    BorderColor = "rgba(34,139,34,1)",
                    Fill = true
                });
            _demandsByShiftChartConfig.Data.Datasets.Add(new LineDataset()
                {
                    Label = "Noite",
                    Data = demandsByShift.Select(d => d.Noite).ToList(),
                    BackgroundColor = "rgba(30,144,255,0.2)",
                    BorderColor = "rgba(30,144,255,1)",
                    Fill = true
                });
            StateHasChanged();
        }

    }

    public List<DemandByShiftModel> FillData(List<HistoricoAssistencia> historico)
    {
        List<DemandByShiftModel> result = historico.AsEnumerable()
            .GroupBy(d => new { Dia = d.Data.Date })
            .Select(x => new DemandByShiftModel
                {
                    Dias = x.Key.Dia,
                    Manha = x.Count(d => d.Data.Date.Equals(x.Key.Dia.Date) &&
                        d.Data.Hour >= 4 && d.Data.Hour < 13),
                    Tarde = x.Count(d => d.Data.Date.Equals(x.Key.Dia.Date) && 
                        d.Data.Hour >= 13 && d.Data.Hour < 23),
                    Noite = x.Count(d => d.Data.Date.Equals(x.Key.Dia.Date) && 
                        d.Data.Hour >= 0 && d.Data.Hour < 4),
                }).OrderBy(d=>d.Dias).ToList();
        return result;
    }
    

}
